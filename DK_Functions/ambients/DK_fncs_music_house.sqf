if !(isServer) exitWith {};


#define musicEnvArea_Build [[22927.9,15761,1.85019],[22905.8,15752.7,1.58642],[22570.3,16394,1.62485],[21925.6,15743,1.44644],[22587.2,17003.7,1.6698],[21586.9,16121.6,1.85252],[21598.5,16178.6,1.82173],[24673.4,18994.5,1.19603],[21585.3,16343.9,3.56844],[21598,16388.6,1.59519],[21562,16364,1.57193],[21540.4,16341.4,1.68679],[21534.1,16351.9,1.61857],[21531.7,16382.8,3.75461],[21430.7,16207.5,3.72964],[21517.2,16393.4,1.69269],[21516.8,16406.3,1.9954],[21495,16380,3.37694],[21485.4,16378.8,1.8164],[21358.5,16162.7,1.84292],[21405.8,16256.4,1.62732],[21393,16288.4,1.42968],[21423.3,16360.8,3.31895],[21349,16223.4,3.7229],[21340.2,16218.9,3.4884],[21433.3,16405.5,3.39329],[21447.6,16442.3,1.58473],[21394.2,16371.4,1.83122],[21402.9,16391.4,1.50873],[21358.8,16328.3,1.66902],[21403.1,16427.6,1.58829],[21413.9,16464.7,1.8468],[21317.3,16325.3,1.89626],[21360.9,16440.7,1.62312],[21328.6,16404.5,1.72912],[21260.1,16310.7,3.4349],[21252.7,16304,3.36537],[21233.1,16291.8,1.84966],[22588.9,18073,2.01333],[21241.2,16320.8,3.74223],[21223.2,16304.6,1.43083],[21296.4,16467.9,3.38686],[21191.6,16305.8,1.58027],[21161.5,16254.1,1.84154],[21152.3,16243.7,1.63244],[22184,17780.3,1.61409],[25733.1,19773.8,2.02675],[20948.1,16029.7,2.18002],[20926.9,16053,1.74001],[21541.9,17192.9,1.84916],[21181.2,16691.6,1.81532],[20414.6,11807.6,3.731],[21267.8,16890.9,1.84205],[21247.9,16917,1.84725],[21215.8,16868.8,1.19102],[20390.8,11662.6,2.07222],[21202.9,16858.4,1.19145],[21472.2,17266.1,1.65384],[20354.9,11793.6,3.9497],[20380.9,11670.9,2.36313],[20356.2,11763,1.76954],[20343.2,11783.5,2.3332],[20320.8,11856.6,2.14191],[21105.9,16744.2,1.6009],[20349.9,11630.3,2.20638],[21425.3,17280.9,1.84336],[20328.7,11692.9,3.78059],[20315.5,11743.6,3.43335],[20345.5,11605.1,2.4521],[20331,11643.6,4.0022],[20303,11739.6,1.64221],[20337.1,11595.4,1.8954],[20294.4,11772.6,2.3525],[20309.3,11703.4,4.63732],[20310.4,11664.9,3.66397],[20293.5,11716.2,1.90783],[20309.4,11640.8,3.72651],[22959.6,18877.7,3.56745],[20258.6,11837.3,2.60669],[20277.3,11746.4,3.69417],[20305,11617.5,3.66928],[20286.7,11686.9,1.82456],[20306.3,11593.2,2.23289],[20285,11658.4,4.24268],[21151.5,16975.9,1.53052],[20258.5,11717,2.19342],[21131.6,16960,1.84917],[20276.3,11609.5,4.94934],[20252,11628.9,4.53529],[22510.7,18601.9,1.71543],[22238.7,18364.1,1.64409],[21096.5,16975.2,3.38046],[20202.7,11773.1,1.84664],[20213.6,11703,3.20039],[20235,11611.1,3.5605],[20218.3,11646.4,3.68079],[20184.6,11792.5,3.34663],[21116.4,17038,1.19506],[20198.5,11727.2,4.19436],[20214.3,11658.8,2.73833],[20187.7,11757.6,4.08541],[20179.3,11779.2,3.96216],[21095.5,17022.9,1.71521],[21133.8,17111.7,1.8279],[20176.5,11705.5,3.57539],[21112.6,17099,3.57289],[20992.7,16914.7,4.40004],[21036.1,16988.8,3.74541],[20982.7,16911,4.47287],[21010,16963.6,4.21976],[21045.6,17026.7,3.86817],[20138.9,11723,2.51267],[20144.2,11694.5,4.35154],[21033.2,17019.3,4.02018],[21014.6,16993.5,4.68721],[21005.3,16988.6,3.89848],[20996.2,16979.7,3.95249],[20126.5,11719.4,2.73294],[21135.1,17220.4,1.84898],[21004.1,17034.5,1.70321],[21014.4,17056.8,2.32758],[20992.8,17026.6,3.8944],[20976.2,17005.5,1.53278],[20982.3,17034.2,3.93596],[20923.4,16953.5,3.61359],[20928.9,16962.8,4.22474],[20938.4,16990.8,2.74969],[20068.1,11730.9,3.94577],[20949.6,17022,2.11816],[20963.9,17047,3.79244],[21008.2,17124.1,3.94224],[20998,17116.8,3.86526],[20903.4,16968,2.46565],[20962.7,17078.9,1.89503],[20946.6,17070.1,3.99452],[20905.1,17009.4,4.12648],[20990.9,17152.9,2.12995],[20911.5,17033.8,3.92344],[20882.8,16997.1,1.66429],[20004.6,11763.7,3.51178],[20868.1,16999.3,3.8001],[20913.2,17078.5,4.1831],[20925.5,17098.4,1.56518],[20944.8,17137.3,1.80563],[20849.8,16994.4,1.58601],[20883.3,17050.1,3.56455],[20895.4,17081,4.43485],[20958.6,17192.4,1.82548],[20886,17084.8,1.86995],[20905.6,17121.8,3.8016],[26533.4,20505.2,1.61459],[20854.3,17073.9,1.84093],[20865.8,17095.7,1.62696],[20881.4,17143.1,2.42916],[20821.6,17099.5,4.14973],[20985.6,17607.9,1.61086],[24001.1,20120.4,1.85138],[20704.5,17315.1,1.75793],[19506,13275.5,1.79387],[19504.8,13346.8,1.70728],[19492.5,13232.2,1.57214],[20529,17101.9,1.76878],[19486,13166.6,1.57379],[19482.2,13255.4,1.85716],[19498.8,12757.7,1.19109],[19473.1,13292.6,1.83553],[19459.9,13216.1,2.00579],[19456.2,13233.4,1.37616],[19453.2,13181.6,1.64846],[19446.3,13263.2,3.42676],[19432.1,13192,1.68211],[19425.1,13244.2,3.47806],[19412.7,13292.6,1.56224],[19405.5,13177.9,1.82326],[19404.6,13213.4,1.78173],[19375.9,13276.6,1.5475],[19359.5,13262.8,3.38099],[19347.3,13276.8,3.55613],[19343.3,13235.4,3.52174],[19318,13242.6,3.67503],[19310.5,13235.6,3.68674],[19308.4,13214.7,3.78795],[19308.1,13253.7,1.62027],[19303.4,13328,1.8873],[19302,13298.7,1.64752],[19294.9,13244.8,1.62308],[21791,7587.11,1.8336],[19275.2,13176.3,1.84049],[21574.8,7759.54,1.83711],[21757,7581.59,1.69313],[21710.9,7607.67,1.84315],[20608.3,8894.43,3.55294],[21615,7688.89,1.64288],[20626.2,8852.94,2.674],[19248.6,13604.2,1.6672],[20517.4,8993.86,1.70043],[20619.5,8841.81,1.71644],[20547.8,8935.43,2.10462],[20557.9,8912.14,3.48516],[20477.9,9000.94,1.707],[21709.4,7529.5,3.3844],[20487.3,8963.6,3.56277],[20490.7,8954.51,3.38048],[20545.3,8864.66,4.01705],[21661.2,7529.62,3.3576],[19165.6,13096.5,1.87519],[25898.4,21077.6,1.19343],[20481,8886.02,3.58546],[21533.1,7606.81,1.84423],[21587.4,7541.55,1.64029],[20464.9,8859.73,2.05454],[19396.3,15470.7,3.38963],[20235,8911.03,3.57244],[20214.5,8934.04,2.15849],[22482.6,19990.3,1.92122],[25402.9,21328.7,1.50605],[19316.6,16349.6,3.52884],[25409.9,21458.6,1.6525],[26102.4,21643.2,1.84484],[26131.8,21669.6,1.82172],[26669.5,21719.6,1.52534],[25365.3,21567,2.39067],[19377.8,9647.35,1.19437],[22372.8,20438.9,4.13197],[19121.6,16519,1.82686],[25824.2,21770.2,1.45322],[21141,19584.7,1.19437],[22135.7,20407.9,2.07566],[18951.9,16513.2,3.53306],[19135.6,16940.2,1.84499],[18916.9,16478.5,1.81097],[18902.6,16536.3,1.63562],[18915.3,16585.8,1.65254],[18789,16289,3.56661],[18893.3,16577,1.85061],[18818.5,16385.9,1.83938],[18842.7,16465.1,3.52102],[18779.7,16319.1,1.53768],[18789.1,16393.9,3.46192],[20923.4,6926.59,1.65748],[18794.1,16446.9,1.53006],[18836.4,16570.6,3.91313],[18851.6,16622.1,3.54727],[18851.3,16665.8,1.63282],[18802.8,16605.9,1.48433],[18398.5,15344.2,2.11788],[18783.4,16569.6,3.52668],[25344.7,22001.9,1.65757],[18816.2,16667,3.52293],[18728.4,16446.3,1.64212],[18753.7,16513.1,3.50371],[18319.7,15072.3,1.93584],[18826.4,16716.4,1.83369],[18348.7,11344.4,2.2811],[18324.1,15106,1.84182],[18753.7,16579,4.02934],[18774.3,16631.9,3.52724],[18738.1,16543.1,1.58376],[18725.9,16514.6,1.6301],[18748.2,16587.1,3.60405],[18224.4,11818.6,1.95951],[18753.7,16630.2,3.54703],[18396.9,15601.6,3.53079],[18723.2,16600.6,3.84706],[18305.5,15270.6,1.90304],[18254.1,15063.1,3.57324],[18802.1,16831.6,1.86321],[20846.3,6792.18,4.03803],[20801.5,6834.65,3.68561],[20805.6,6825.34,3.51695],[20867.7,6763.56,2.1518],[18795.1,16843.9,1.81179],[18700.5,16627.8,1.89071],[20858.6,6753.99,1.83054],[18231.3,15091.8,1.82616],[20816.2,6788.29,3.72607],[20245.5,19176.6,1.683],[18249.2,15210.5,3.51751],[20782.3,6807.3,3.46675],[20830.6,6755.22,1.65615],[20852.1,6732.06,3.79786],[18705.2,16706.9,1.89285],[20767.4,6808,1.76031],[20280.1,19245.3,1.68371],[20862.3,6709.16,3.49211],[18666.9,16665.5,3.46347],[18235.7,15317.1,2.01889],[20695.1,6835.85,3.64888],[18176.3,15095.4,1.71227],[20685.8,6826.29,1.54848],[18292.1,15657.9,1.46562],[20773.3,6731.07,3.58898],[18172.4,15169.4,1.51297],[18193.5,15268.1,1.92209],[18196.7,15303.4,3.36495],[20832.1,6659.22,1.76401],[18676.7,16835.4,3.87097],[20736.5,6731.86,1.6841],[18197.3,15393,3.50736],[18638.3,16766.5,1.64958],[18650.5,16808,3.77668],[18173.3,15334.8,3.74717],[18182.2,15376.4,3.51504],[18149.6,15256.6,1.77852],[18136.7,15201,1.52068],[20855.1,6587.71,3.49376],[20706.9,6727.04,3.73354],[18143.1,15264.4,3.41548],[20864.1,6578.41,1.60871],[18628.5,16794.6,1.65221],[18125.9,15193.4,1.84397],[20874.5,6562.45,1.96163],[18611.3,16773.1,1.63953],[18136.6,15275.8,1.5624],[18150.1,15345.8,3.65075],[18155,15373.9,3.4596],[18155.7,15400.1,3.6067],[18127.8,15291.3,1.86825],[18094.7,15141.1,1.84496],[18096.7,15173,1.50808],[18598,16787.1,1.62534],[18101,15211.6,3.56737],[18123,15336,2.1482],[18101.7,15269.4,3.78379],[18117.2,15349.3,2.20732],[18087.6,15244.6,3.39445],[18080.2,15251.6,2.01289],[18071.7,15213.7,3.57517],[18068.2,15204.5,1.8424],[18054.9,15177.3,3.62741],[18080,15356.3,4.09509],[18039.1,15193.4,1.78317],[18022.9,15188.7,3.55378],[18010.7,15134.4,1.6258],[18046.4,15300.7,1.9457],[18021.6,15278.7,3.80096],[18008.1,15220,2.24387],[17984.2,15120.4,1.83822],[18568.7,16991.1,1.87274],[17973.4,15113,1.58984],[17937.9,15028.2,2.06881],[18517.4,16964.6,3.57115],[17921.7,15085.3,1.68318],[23231.4,21771.5,1.63042],[17928.1,15246.6,2.28188],[17933.6,15283.7,1.71336],[27084.9,22604.5,2.20104],[18481.5,17150.4,1.84039],[22637.7,21670.8,2.15098],[19969.2,19643.9,1.70808],[17492.8,14483.4,1.62526],[26841.7,22937.8,1.83698],[22430,21878.8,1.82492],[22568.8,21958.4,3.88617],[17281.9,12414.3,3.57979],[17228.4,13465.9,3.49193],[26895.5,23101.8,1.6328],[27046,23103.3,1.67397],[27100.8,23106,1.83841],[26835.1,23128.6,4.09575],[26859.9,23144.7,4.2842],[26919.6,23165.8,1.84637],[17145.5,13067,3.38875],[26843.5,23191.1,3.61137],[26976.5,23199.6,1.53861],[27118.4,23201.4,2.02227],[17123.4,12641.9,1.6242],[17110.5,12643.6,3.38713],[27091.7,23228.2,3.67438],[17194.3,11804,1.96558],[26987.2,23231.5,2.06198],[22288.6,22031,1.19047],[26944.8,23236.7,2.1267],[27015,23243.5,3.41994],[27107.3,23248.7,2.07517],[26969.8,23250.2,3.56705],[27308.8,23259.2,3.77947],[27078.7,23264.6,3.38845],[27146.3,23270.5,3.95509],[27043.4,23275.3,3.3874],[26958.7,23282.5,3.6615],[27035.1,23284.5,3.85541],[27118.9,23286.7,1.57272],[17057.7,12491.4,2.13673],[27160.5,23291.1,1.77914],[27025.9,23293.6,3.40013],[27071.9,23295.6,3.5697],[17138,14840.9,1.63129],[27112.6,23299,3.56353],[17025,12837.8,3.46429],[27205.1,23303,1.96892],[26954.5,23304.4,1.43503],[27003.1,23312.6,1.58375],[27098.4,23322.7,3.53813],[27137.1,23324,1.817],[27015.3,23327.3,3.55807],[26969.4,23329.1,1.851],[27097.6,23349.1,3.83891],[27021.5,23350.4,1.88291],[27411.5,23372.2,1.87063],[27126.3,23382,1.85229],[24319.9,23034.5,1.59271],[16891,12827.5,3.46376],[17932.5,8778.52,3.72376],[24839.2,23202.3,1.65324],[16867.3,12954,3.76276],[16870.8,12825.8,3.38131],[16864.7,12924.1,1.63894],[27259.1,23463.6,1.60428],[16855.7,12794.7,1.70831],[16847.8,12907.8,3.75635],[16838.8,12937.2,3.56746],[16828.8,12924.9,1.63843],[27287.3,23490,1.625],[26921.2,23494.2,1.58773],[16818.1,12816,3.39826],[16813.2,12857.2,3.95579],[26945.2,23511.4,1.87155],[23799.2,22989,1.5252],[16923.2,11656.9,1.98362],[16793.8,12832.2,1.87506],[16924.8,15125.6,3.31277],[16923.3,15142.7,3.56422],[16741.1,12930.1,1.80746],[16679,12874.6,3.54355],[27342.2,23703.8,2.02317],[16604.1,12866.5,3.56837],[27039.7,23747.5,1.84214],[16417.7,12649.9,1.5906],[16413.4,12663.7,3.57073],[16475.3,11711.3,3.37421],[16371.6,11423.9,2.10834],[27037.4,24110.2,1.61881],[16212.7,11447.9,1.80627],[26922.2,24266.2,1.51826],[26880.8,24298.9,1.1933],[26954.1,24300.9,1.28473],[26938.4,24313.6,1.21967],[26916,24318.4,1.19529],[26939.4,24337.6,1.19331],[26714.1,24604.5,1.17832],[15837.7,11390,3.24698],[27699.9,24668.2,1.74032],[15660.9,11049,1.98046],[15658.6,10746.8,4.03026],[15576.9,11050.4,2.53611],[15042.9,11329.3,1.84516],[14975.4,11281.1,1.71307],[14914.5,11090.1,1.85638],[14896.5,11063.5,3.56571]]
#define houseTrackList [["Buildings01", 8], ["Buildings02", 16], ["Buildings03", 14.793], ["Buildings04", 8], ["Buildings05", 9.063], ["Buildings06", 8]]

DK_music_house_trackList = +houseTrackList;
DK_music_house_oldSrc = [];


DK_fnc_music_house_select = {

///	// Debug
/*	private _mkrNzme = "DK_mkr_uuut_";

	if !(isNil "buildings_mkrs_debug") then
	{
		{
			deleteMarker _x;

		} forEach buildings_mkrs_debug;
	};

	buildings_mkrs_debug = [];
///	// Debug
*/
	private ["_newPos", "_house", "_nil", "_nbDoors"];


	if (count DK_music_house_oldSrc > 6) then
	{
		DK_music_house_oldSrc = [];
	};

	private _trackNFO = missionNamespace getVariable "houseMusicTrack";
	if (!isNil "_trackNFO") then
	{
		_house = _trackNFO # 2;
		private _nbDoors = getNumber(configFile >> "CfgVehicles" >> (typeOf _house) >> "numberOfDoors");
		if (_nbDoors > 0) then
		{				 
			for "_i" from 1 to _nbDoors do
			{
				[_house,_i] remoteExecCall ["DK_fnc_unlockDoor", DK_isDedi];

				uiSleep 0.1;
			};
		};
	};


	private _exit = false;

	while { !(_exit) } do
	{
		waitUntil { uiSleep 3; !(allPlayers isEqualTo []) };

		_newPos = selectRandom musicEnvArea_Build;
		if ( (DK_music_house_oldSrc findIf { _newPos distance2D _x < 300 } isEqualTo -1) && { (playableUnits findIf { _newPos distance2D _x < 60 } isEqualTo -1) && { !(playableUnits findIf { _newPos distance2D _x < 500 } isEqualTo -1) } } ) then
		{
			_house = (nearestObjects [_newPos, ["house", "building"], 3, true]) # 0;

			if ( (!isNil "_house") && { (damage _house < 0.5) } ) then
			{
				_exit = true;

				_trackNFO = selectRandom DK_music_house_trackList;
				_nul = DK_music_house_trackList deleteAt (DK_music_house_trackList find _trackNFO);

				if (DK_music_house_trackList isEqualTo []) then
				{
					DK_music_house_trackList = +houseTrackList;
					_nil = DK_music_house_trackList deleteAt (DK_music_house_trackList find _trackNFO);
				};

				_trackNFO pushBackUnique _house;
				missionNamespace setVariable ["houseMusicTrack", _trackNFO, true];

				_nbDoors = getNumber(configFile >> "CfgVehicles" >> (typeOf _house) >> "numberOfDoors");
				if (_nbDoors > 0) then
				{						 
					for "_i" from 1 to _nbDoors do
					{
					//	_house animate [format["door_%1_rot",_i],0];
						_house animateSource [format["door_%1_rot",_i], 0];
						_house setVariable [format["bis_disabled_Door_%1",_i], 1, true];
					};
				};

/*				///	// Debug
					_mkrNzme = _mkrNzme + (str (random 1000));
					private _markerstr = createMarker [_mkrNzme, _newPos];
					_markerstr setMarkerShape "ICON";
					_markerstr setMarkerType "mil_dot";
					_markerstr setMarkerColor "ColorPink";
					_markerstr setMarkerSize [1, 0.8];
					buildings_mkrs_debug pushBackUnique _markerstr;
				///	// Debug
*/			};
		};

		if _exit exitWith {};

		uiSleep 0.1;
	};
};
